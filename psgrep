#!/bin/sh

psgrep() {
 local hide_parent=0
 if [ x"$1" = x"-p" ] || [ x"$1" = x"--hide-parent" ]; then
  hide_parent=1
  shift
 elif [ x"$1" = x"--" ]; then
  shift
 fi
 if [ x"$1" = x"" ]; then
  echo "Usage: $0 [-p|--hide-parent|--] pattern"
  return 2
 fi
 
 local ps_opts=auwwx
 if ! ps $ps_opts >/dev/null 2>&1; then
  ps_opts=ww
 fi
 if ! ps $ps_opts >/dev/null 2>&1; then
  ps_opts=
 fi
 
 local header="`ps $ps_opts | head -n1`"
 printf '\033[1m%s\033[0m\n' "$header"
 local processes="`ps $ps_opts`"
 if [ $hide_parent -ne 0 ]; then
  printf '%s' "$processes" | grep "$@" \
   | grep -v -e '^\(\S\+\s\+\)\?\s*'"$$"'\s' \
   | grep -v -e '^\(\S\+\s\+\)\?\s*'"$PPID"'\s'
 else
  printf '%s' "$processes" | grep "$@" \
   | grep -v -e '^\(\S\+\s\+\)\?\s*'"$$"'\s'
 fi
}


pswatch() {
 local interval=
 if (printf '%s' "$1" | grep -q -e '^[0-9]\+\(\.[0-9]\+\)\?$'); then
  interval="-n$1"
  shift
 elif [ x"$1" = x"--" ]; then
  shift
 fi
 if [ x"$1" = x"" ]; then
  echo "Usage: pswatch [interval (s)|--] pattern"
  return 2
 fi
 export __FROM_PSWATCH=1
 if readlink -f "$(which watch)" | grep -q -e '/watch$'; then
  exec watch -c "$interval" "$0" -p "$@"
 else
  exec watch "$interval" "$0" -p "$@"
 fi
}


if [ x"$(basename "$0" .sh)" = x"pswatch" ] && [ x"$__FROM_PSWATCH" != x"1" ]; then
 pswatch "$@"
else
 psgrep "$@"
fi
