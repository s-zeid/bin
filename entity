#!/usr/bin/env python2

import argparse
import htmlentitydefs
import re
import sys

def char2entity(char):
 return "&%s;" % htmlentitydefs.codepoint2name.get(ord(char), "#x%s" % hex(ord(char))[2:])

def entity2char(entity):
 entity = re.match(r"^&?(.*?);?$", entity).group(1)
 if re.match(r"^#([0-9]+)$", entity):
  return unichr(int(entity[1:], 10))
 if re.match(r"^#x([0-9a-fA-F]+)$", entity):
  return unichr(int(entity[2:], 16))
 codepoint = htmlentitydefs.name2codepoint.get(entity, None)
 return unichr(codepoint) if codepoint else None

def main(argv):
 p = argparse.ArgumentParser()
 p.add_argument("-x", "--hex", "--code-point", dest="code_point", action="store_true",
                help="show the version number and exit")
 p.add_argument("input", metavar="entity-or-char",
                help="the character to convert to an entity or"
                     " the entity to convert to a character")
 try:
  args = p.parse_args(argv[1:])
 except SystemExit as exc:
  return exc.code
 
 input_ = unicode(args.input, "utf-8")
 mode   = (char2entity if len(input_) == 1 else entity2char)
 result = mode(input_)
 if result is None:
  print >> sys.stderr, "error: invalid entity %s" % repr(input_)[1:]
  return 1
 
 if args.code_point:
  if mode == char2entity:
   result = input_
  print "U+" + re.sub(r"^0x", "", hex(ord(result)))
 else:
  print result.encode("utf-8")
 return 0

if __name__ == "__main__":
 sys.exit(main(sys.argv))
